// ==UserScript==
// @name         Battered shield helper
// @namespace    https://github.com/AlorelUserscripts/battered-shield-notifier
// @version      0.6
// @description  Helps with your battered shields
// @author       Alorel
// @include      /^https?:\/\/(?=www\.)?batteredshield\.com\/game\/?/
// @homepage     https://github.com/AlorelUserscripts/battered-shield-notifier
// @supportURL   https://github.com/AlorelUserscripts/battered-shield-notifier/issues
//
// @downloadURL  https://raw.githubusercontent.com/AlorelUserscripts/battered-shield-notifier/master/battered-shield-helper.user.js
// @updateURL    https://raw.githubusercontent.com/AlorelUserscripts/battered-shield-notifier/master/battered-shield-helper.meta.js
//
// @icon64       https://cdn.rawgit.com/AlorelUserscripts/battered-shield-notifier/3cad641d61497ba25be33ae9db0ef30742628452/assets/icon-64.png
// @icon         https://cdn.rawgit.com/AlorelUserscripts/battered-shield-notifier/3cad641d61497ba25be33ae9db0ef30742628452/assets/icon-32.png
//
// @run-at       document-start
//
// @grant        GM_notification
// @grant        GM_info
// @grant        GM_getResourceText
// @grant        GM_registerMenuCommand
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_listValues
//
// @require      https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js
// @require      https://cdn.jsdelivr.net/knockout/3.4.1/knockout.js
// @require      https://cdn.jsdelivr.net/buzz/1.1.0/buzz.min.js
// @require      https://cdn.jsdelivr.net/bluebird/3.4.7/bluebird.min.js
// @require      https://cdn.jsdelivr.net/remodal/1.1.1/remodal.min.js
// @require      https://raw.githubusercontent.com/AlorelUserscripts/battered-shield-notifier/44d6524c94a9fd58a1c8c63909debbbcbe00ba8d/lib/jquery.toast.min.js

// @resource toast_css https://raw.githubusercontent.com/AlorelUserscripts/battered-shield-notifier/44d6524c94a9fd58a1c8c63909debbbcbe00ba8d/lib/jquery.toast.min.css
// @resource remodal_css1 https://cdn.jsdelivr.net/remodal/1.1.1/remodal-default-theme.css
// @resource remodal_css2 https://cdn.jsdelivr.net/remodal/1.1.1/remodal.css
// @resource bs_css1 https://cdn.jsdelivr.net/bootstrap/3.3.7/css/bootstrap.min.css
// @resource bs_css2 https://cdn.jsdelivr.net/bootstrap/3.3.7/css/bootstrap-theme.min.css
// ==/UserScript==
!function(t,e,n,i,o,r,a,s,l,c,u,d){c.options.deferUpdates=!0,function t(e,n,i){function o(a,s){if(!n[a]){if(!e[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(r)return r(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[a]={exports:{}};e[a][0].call(u.exports,function(t){var n=e[a][1][t];return o(n?n:t)},u,u.exports,t,e,n,i)}return n[a].exports}for(var r="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}({1:[function(t,i,o){"use strict";u.prototype.ucFirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)},$(d).one("DOMContentLoaded",function(){["remodal_css1","remodal_css2","toast_css"].map(n).map(function(t){return $("<style>"+t+"</style>")[0]}).forEach(function(t){return d.body.appendChild(t)}),$("<style>.remodal-overlay,.remodal-wrapper{z-index:100000}</style>").appendTo(d.body),t("./inc/observers/action-point"),t("./inc/observers/action-timer"),t("./inc/observers/captcha"),t("./inc/observers/hp"),t("./inc/observers/skill-levels"),t("./inc/subscriptions/action-points"),t("./inc/subscriptions/actions-finished"),t("./inc/subscriptions/captcha"),t("./inc/subscriptions/full-health"),t("./inc/subscriptions/skill-levels"),t("./inc/register-menu"),t("./inc/toast")(e.script.name+" v"+e.script.version+" loaded.")})},{"./inc/observers/action-point":6,"./inc/observers/action-timer":7,"./inc/observers/captcha":8,"./inc/observers/hp":9,"./inc/observers/skill-levels":11,"./inc/register-menu":12,"./inc/subscriptions/action-points":14,"./inc/subscriptions/actions-finished":15,"./inc/subscriptions/captcha":16,"./inc/subscriptions/full-health":17,"./inc/subscriptions/skill-levels":18,"./inc/toast":19}],2:[function(t,e,n){"use strict";var i=$("#Profile_Tabs").find(".SkillHolder"),o=function(){var t=$(this);return{name:t.find(">.name>span").text().trim().toLowerCase(),level:parseInt(t.find(">.level>.Level").text().trim())}},r=function(t,e){return t[e.name]=e.level,t},a=function(){return i.find(">div")};console.time("Waiting for levels DOM");var s=new l(function(t){var e=setInterval(function(){a().length>=12&&(console.timeEnd("Waiting for levels DOM"),clearInterval(e),t())},25)}),c=function(){return $.makeArray(i.find(">div").map(o)).reduce(r,{})};e.exports=function(){return s.then(c)},e.exports.ready=s},{}],3:[function(t,e,n){"use strict";var i=function(t,e){var n=c.observable(parseInt(o(t,e)||e||0));return n.subscribe(function(e){return r(t,parseInt(e))}),n},a=function(t,e){var n=c.observable(1==o(t,e));return n.subscribe(function(e){return r(t,e?1:0)}),n};e.exports={integer:i,boolean:a}},{}],4:[function(t,n,r){"use strict";var s=t("./gm-observable"),l=t("./toast"),u=t("./uuid"),f={notify_HP:s.boolean("notify_hp",!0)},p={hide:!1,subscribe:!0},v=function(t){var e=new CustomEvent("battered-shield-helper."+this,{detail:t});d.dispatchEvent(e)},b=function(t,e,i){return i=$.extend({},p,i||{}),Object.defineProperty(f,t,{configurable:!1,writable:!1,enumerable:!i.hide,value:e}),i.subscribe&&e.subscribe(v,t),n.exports};b("apPCT",c.observable(0)),b("timer",c.observable(0)),b("hpPCT",c.observable(0)),b("captcha",c.observable(!1)),b("notify_captcha",s.boolean("notify_captcha",!0)),b("notify_timer",s.boolean("notify_timer",!0)),b("notify_AP_pct",s.integer("notify_ap_pct",100)),b("notify_HP_pct",s.integer("notify_hp_pct",75)),n.exports=Object.defineProperties({add:b,addInternal:function(t,e){for(;;)try{var n="_"+u();return b(n,t,$.extend({subscribe:!1,hide:!0},e||{})),n}catch(t){}},ready:{skillLevels:t("./get-levels")().then(function(t){var e=!0,n=!1,i=void 0;try{for(var o,r=function(){var e=o.value,n=c.observable(t[e]),i=s.integer("notify_at_lvl_"+e,0);b("lvl_"+e,n),b("notify_at_lvl_"+e,i),b("lvl_should_notify_"+e,c.pureComputed(function(){return i()>0&&n()>=i()}))},a=Object.keys(t)[Symbol.iterator]();!(e=(o=a.next()).done);e=!0)r()}catch(t){n=!0,i=t}finally{try{!e&&a.return&&a.return()}finally{if(n)throw i}}return t})}},{model:{get:function(){return f},configurable:!0,enumerable:!0}}),i("Debug "+e.script.name,function(){var t={},e={},n=!0,i=!1,r=void 0;try{for(var s,c=Object.keys(f)[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var u=s.value;t[u]=f[u]()}}catch(t){i=!0,r=t}finally{try{!n&&c.return&&c.return()}finally{if(i)throw r}}var d=!0,p=!1,v=void 0;try{for(var b,m=a()[Symbol.iterator]();!(d=(b=m.next()).done);d=!0){var y=b.value;e[y]=o(y)}}catch(t){p=!0,v=t}finally{try{!d&&m.return&&m.return()}finally{if(p)throw v}}console.debug({observables:t,storage:e}),l("See the console")})},{"./get-levels":2,"./gm-observable":3,"./toast":19,"./uuid":20}],5:[function(e,n,i){"use strict";var o=e("./sfx").notification,r={timeout:36e5,sound:!0,highlight:!0};n.exports=function(e,n){console.debug("Notifying: "+e),n=$.extend({text:e},r,n||{}),t(n),n.sound&&o.play()}},{"./sfx":13}],6:[function(t,e,n){"use strict";var i=d.querySelector(".attrib_value.ap_data"),o=t("../model").model.apPCT,r=t("../x-out-of-y");new MutationObserver(function(){var t=i.textContent.trim().match(r);t&&o(parseFloat(t[1])/parseFloat(t[2])*100)}).observe(i,t("./settings.json"))},{"../model":4,"../x-out-of-y":21,"./settings.json":10}],7:[function(t,e,n){"use strict";var i=d.querySelector(".timer_plaque"),o=t("../model").model.timer;new MutationObserver(function(){var t=i.textContent.trim();o(isNaN(t)?t:parseFloat(t))}).observe(i,t("./settings.json"))},{"../model":4,"./settings.json":10}],8:[function(t,e,n){"use strict";var i=$(".PopupCaptcha"),o=t("../model").model.captcha;new MutationObserver(function(){o(i.is(":visible"))}).observe(i[0],t("./settings.json"))},{"../model":4,"./settings.json":10}],9:[function(t,e,n){"use strict";var i=d.querySelector('.attrib_name[title="Hit Points"]').nextElementSibling,o=t("../model").model.hpPCT,r=t("../x-out-of-y");new MutationObserver(function(){var t=i.textContent.trim().match(r);t&&o(parseFloat(t[1])/parseFloat(t[2])*100)}).observe(i,t("./settings.json"))},{"../model":4,"../x-out-of-y":21,"./settings.json":10}],10:[function(t,e,n){e.exports={childList:!0,characterData:!0,attributes:!0,subtree:!0}},{}],11:[function(t,e,n){"use strict";var i=t("../model");i.ready.skillLevels.then(function(){var e=$("#mainContainer").find(".timer_line"),n=i.model,o=e.find(".Level")[0],r=e.find(".Skill")[0],a=t("./settings.json"),s=new MutationObserver(function(){if(o&&r){var t=o.textContent,e=r.textContent;t&&e&&n["lvl_"+e.trim().toLowerCase()](parseInt(t.trim()))}});s.observe(o.parentNode,a),console.debug("Skill level observer initialised")})},{"../model":4,"./settings.json":10}],12:[function(t,i,o){"use strict";var r=t("./model"),a=t("./uuid"),s=function(){var t=$(this).attr("data-key");r.model[t](!r.model[t]())},l=function(t,e){return $("<button/>").attr({type:"button",class:"btn","data-bind":"css: {'btn-danger': !"+t+"(), 'btn-success': "+t+"}","data-key":t}).click(s).append($("<span>"+e+": </span>"),$('<span data-bind="text: '+t+"() ? 'Enabled' : 'Disabled'\"/>"))},u=$('<div data-remodal-id="'+e.script.name+'"><button data-remodal-action="close" class="remodal-close"></button></div>'),f=d.createElement("div");u.append(f);var p=f.createShadowRoot(),v=$('<div class="container-fluid text-left"/>')[0];["bs_css1","bs_css2"].map(n).map(function(t){return"<style>"+t+"</style>"}).forEach(function(t){return p.appendChild($(t)[0])}),p.appendChild($("<style>.vertical-middle td{vertical-align:middle!important}</style>")[0]),p.appendChild(v);var b=$("<tbody/>");r.ready.skillLevels.then(function(t){var e=!0,n=!1,i=void 0;try{for(var o,s=function(){var t=o.value,e=a(),n=r.addInternal(c.pureComputed(function(){return r.model["notify_at_lvl_"+t]()<1?"Disabled":r.model["notify_at_lvl_"+t]()<=r.model["lvl_"+t]()?"Reached":r.model["notify_at_lvl_"+t]()-r.model["lvl_"+t]()+" to go!"})),i=r.addInternal(c.pureComputed(function(){return r.model["notify_at_lvl_"+t]()<1?"active text-muted":r.model["notify_at_lvl_"+t]()<=r.model["lvl_"+t]()?"success text-success":"info text-primary"}));b.append($('<tr data-bind="css:'+i+'"/>').append('<td><label for="'+e+'">'+t.ucFirst()+"</label></td>",$("<td/>").append($("<input/>").attr({type:"number",id:e,min:0,style:"width:85px",class:"form-control input-sm","data-bind":"value: notify_at_lvl_"+t})),$('<td><span data-bind="text:'+n+'"/></td>')))},l=Object.keys(t).sort()[Symbol.iterator]();!(e=(o=l.next()).done);e=!0)s()}catch(t){n=!0,i=t}finally{try{!e&&l.return&&l.return()}finally{if(n)throw i}}c.applyBindings(r.model,b[0])});var m=$('<div class="col-md-6"/>'),y=$('<div class="col-md-6"/>'),h=$('<ul class="list-group"/>'),x=[{name:"AP",desc:"Notifies you when AP is >= the given percent",ob:"notify_AP_pct"},{name:"HP",desc:"Notifies you when HP is >= the given percent",ob:"notify_HP_pct"}],_=!0,g=!1,C=void 0;try{for(var w,k=function(){var t=w.value,e=r.addInternal(c.pureComputed(function(){return r.model[t.ob]()>0?"text-success":"text-danger"})),n=a();h.append($('<li class="list-group-item"/>').append($("<label/>").attr({for:n,title:t.desc+". Set to 0 to disable."}).text(t.name),$("<input/>").attr({type:"number",min:0,id:n,max:100,style:"width:65px;display:inline-block;margin-left:5px;margin-right:5px",class:"form-control input-sm","data-bind":"textInput:"+t.ob}),$("<span/>").attr("data-bind",["text: "+t.ob+"() > 0 ? 'On' : 'Off'","css: "+e].join(","))))},P=x[Symbol.iterator]();!(_=(w=P.next()).done);_=!0)k()}catch(t){g=!0,C=t}finally{try{!_&&P.return&&P.return()}finally{if(g)throw C}}m.append('<h3 title="Notifies you when you reach a given skill level. Set to 0 to disable">Level notifications</h3>',$('<table class="table table-condensed vertical-middle"/>').append(b)),y.append("<h3>Trigger notifications</h3>",h),$(v).append('<h1 class="text-center">'+e.script.name+" v"+e.script.version+"</h1>","<h3>Notification toggles</h3>",$('<div class="btn-group btn-group-xs">').append(l("notify_captcha","Captcha"),l("notify_timer","Idle")),"<hr/>",m,y);var M=u.remodal({hashTracking:!1});$("#Left_menu").find(">.LeftMenu.LeftMenuLinks.side_block").prepend('<div class="smallchain"/>',$('<div class="toggle" style="text-align:center"><a href="javascript:void(0)">'+e.script.name+" options</a></div>").click(function(){M.open()})),c.applyBindings(r.model,v)},{"./model":4,"./uuid":20}],13:[function(t,e,n){"use strict";var i=new s.sound("https://cdn.rawgit.com/AlorelUserscripts/battered-shield-notifier/3cad641d61497ba25be33ae9db0ef30742628452/assets/notification.mp3",{preload:!0,autoplay:!1,loop:!1});e.exports={notification:i}},{}],14:[function(t,e,n){"use strict";var i={timeout:3e4},o=t("../notify"),r=t("../model").model;r.apPCT.subscribe(function(t){var e=r.notify_AP_pct();e>0&&t>=e&&o("AP is at "+t+"%",i)})},{"../model":4,"../notify":5}],15:[function(t,e,n){"use strict";var i="Stopped",o=t("../notify"),r=t("../model").model;r.timer.subscribe(function(t){i==t&&r.notify_timer()&&o("Actions finished: "+t)})},{"../model":4,"../notify":5}],16:[function(t,e,n){"use strict";var i=t("../notify"),o={timeout:36e5},r=t("../model").model;r.captcha.subscribe(function(t){t&&r.notify_captcha()&&i("Captcha!",o)})},{"../model":4,"../notify":5}],17:[function(t,e,n){"use strict";var i=t("../notify"),o=t("../model").model,r={timeout:3e4};o.hpPCT.subscribe(function(t){var e=o.notify_HP_pct();e>0&&t>=e&&i("HP at "+t+"%!",r)})},{"../model":4,"../notify":5}],18:[function(t,e,n){"use strict";var i=t("../notify"),o=t("../model");o.ready.skillLevels.then(function(t){var e=o.model,n=function(t){var n=this;t&&(i(n+" has reached the target level of "+e["notify_at_lvl_"+n]()+"!"),e["notify_at_lvl_"+n](0))},r=!0,a=!1,s=void 0;try{for(var l,c=Object.keys(t)[Symbol.iterator]();!(r=(l=c.next()).done);r=!0){var u=l.value;e["lvl_should_notify_"+u].subscribe(n,u),console.debug({skill:u,val:e["lvl_should_notify_"+u]()})}}catch(t){a=!0,s=t}finally{try{!r&&c.return&&c.return()}finally{if(a)throw s}}console.debug("Skill level subscriptions initialised")})},{"../model":4,"../notify":5}],19:[function(t,e,n){"use strict";var i={showHideTransition:"fade",allowToastClose:!0,hideAfter:5e3,stack:100,position:"top-right",bgColor:"#444444",textColor:"#eeeeee",textAlign:"left",loader:!1,loaderBg:"#9EC600"};e.exports=function(t,e){console.debug("Toasting: "+t),$.toast($.extend({text:t},i,e||{}))}},{}],20:[function(t,e,n){"use strict";var i=/[xy]/g,o="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx";e.exports=function(){var t=Date.now();return o.replace(i,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)})}},{}],21:[function(t,e,n){"use strict";e.exports=/([0-9\.]+)\s*\/\s*([0-9\.]+)/},{}]},{},[1])}(GM_notification,GM_info,GM_getResourceText,GM_registerMenuCommand,GM_getValue,GM_setValue,GM_listValues,buzz,Promise,ko,String,document);
