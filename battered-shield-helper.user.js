// ==UserScript==
// @name         Battered shield helper
// @namespace    https://github.com/AlorelUserscripts/battered-shield-notifier
// @version      0.5
// @description  Helps with your battered shields
// @author       Alorel
// @include      /^https?:\/\/(?=www\.)?batteredshield\.com\/game\/?/
// @homepage     https://github.com/AlorelUserscripts/battered-shield-notifier
// @supportURL   https://github.com/AlorelUserscripts/battered-shield-notifier/issues
//
// @downloadURL  https://raw.githubusercontent.com/AlorelUserscripts/battered-shield-notifier/master/battered-shield-helper.user.js
// @updateURL    https://raw.githubusercontent.com/AlorelUserscripts/battered-shield-notifier/master/battered-shield-helper.meta.js
//
// @icon64       https://cdn.rawgit.com/AlorelUserscripts/battered-shield-notifier/3cad641d61497ba25be33ae9db0ef30742628452/assets/icon-64.png
// @icon         https://cdn.rawgit.com/AlorelUserscripts/battered-shield-notifier/3cad641d61497ba25be33ae9db0ef30742628452/assets/icon-32.png
//
// @run-at       document-start
//
// @grant        GM_notification
// @grant        GM_info
// @grant        GM_getResourceText
// @grant        GM_registerMenuCommand
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_listValues
//
// @require      https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js
// @require      https://cdn.jsdelivr.net/knockout/3.4.1/knockout.js
// @require      https://cdn.jsdelivr.net/buzz/1.1.0/buzz.min.js
// @require      https://cdn.jsdelivr.net/bluebird/3.4.7/bluebird.min.js
// @require      https://cdn.jsdelivr.net/remodal/1.1.1/remodal.min.js
// @require      https://raw.githubusercontent.com/AlorelUserscripts/battered-shield-notifier/44d6524c94a9fd58a1c8c63909debbbcbe00ba8d/lib/jquery.toast.min.js

// @resource toast_css https://raw.githubusercontent.com/AlorelUserscripts/battered-shield-notifier/44d6524c94a9fd58a1c8c63909debbbcbe00ba8d/lib/jquery.toast.min.css
// @resource remodal_css1 https://cdn.jsdelivr.net/remodal/1.1.1/remodal-default-theme.css
// @resource remodal_css2 https://cdn.jsdelivr.net/remodal/1.1.1/remodal.css
// @resource bs_css1 https://cdn.jsdelivr.net/bootstrap/3.3.7/css/bootstrap.min.css
// @resource bs_css2 https://cdn.jsdelivr.net/bootstrap/3.3.7/css/bootstrap-theme.min.css
// ==/UserScript==
!function(t,e,n,i,o,r,s,a,l,c,u,d){c.options.deferUpdates=!0,function t(e,n,i){function o(s,a){if(!n[s]){if(!e[s]){var l="function"==typeof require&&require;if(!a&&l)return l(s,!0);if(r)return r(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[s]={exports:{}};e[s][0].call(u.exports,function(t){var n=e[s][1][t];return o(n?n:t)},u,u.exports,t,e,n,i)}return n[s].exports}for(var r="function"==typeof require&&require,s=0;s<i.length;s++)o(i[s]);return o}({1:[function(t,i,o){"use strict";u.prototype.ucFirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)},$(d).one("DOMContentLoaded",function(){["remodal_css1","remodal_css2","toast_css"].map(n).map(function(t){return $("<style>"+t+"</style>")[0]}).forEach(function(t){return d.body.appendChild(t)}),$("<style>.remodal-overlay,.remodal-wrapper{z-index:100000}</style>").appendTo(d.body),t("./inc/observers/action-point"),t("./inc/observers/action-timer"),t("./inc/observers/captcha"),t("./inc/observers/hp"),t("./inc/observers/skill-levels"),t("./inc/subscriptions/action-points"),t("./inc/subscriptions/actions-finished"),t("./inc/subscriptions/captcha"),t("./inc/subscriptions/full-health"),t("./inc/subscriptions/skill-levels"),t("./inc/register-menu"),t("./inc/toast")(e.script.name+" v"+e.script.version+" loaded.")})},{"./inc/observers/action-point":6,"./inc/observers/action-timer":7,"./inc/observers/captcha":8,"./inc/observers/hp":9,"./inc/observers/skill-levels":11,"./inc/register-menu":12,"./inc/subscriptions/action-points":14,"./inc/subscriptions/actions-finished":15,"./inc/subscriptions/captcha":16,"./inc/subscriptions/full-health":17,"./inc/subscriptions/skill-levels":18,"./inc/toast":19}],2:[function(t,e,n){"use strict";var i=$("#Profile_Tabs").find(".SkillHolder"),o=function(){var t=$(this);return{name:t.find(">.name>span").text().trim().toLowerCase(),level:parseInt(t.find(">.level>.Level").text().trim())}},r=function(t,e){return t[e.name]=e.level,t},s=function(){return i.find(">div")};console.time("Waiting for levels DOM");var a=new l(function(t){var e=setInterval(function(){s().length>=12&&(console.timeEnd("Waiting for levels DOM"),clearInterval(e),t())},25)}),c=function(){return $.makeArray(i.find(">div").map(o)).reduce(r,{})};e.exports=function(){return a.then(c)},e.exports.ready=a},{}],3:[function(t,e,n){"use strict";var i=function(t,e){var n=c.observable(parseInt(o(t,e)||e||0));return n.subscribe(function(e){return r(t,parseInt(e))}),n},s=function(t,e){var n=c.observable(1==o(t,e));return n.subscribe(function(e){return r(t,e?1:0)}),n};e.exports={integer:i,boolean:s}},{}],4:[function(t,n,r){"use strict";var a=t("./gm-observable"),l=t("./toast"),u={apPCT:c.observable(0),timer:c.observable(0),hpPCT:c.observable(0),captcha:c.observable(!1),notify_AP:a.boolean("notify_ap",!0),notify_HP:a.boolean("notify_hp",!0),notify_captcha:a.boolean("notify_captcha",!0),notify_timer:a.boolean("notify_timer",!0)},f=function(t){var e=new CustomEvent("battered-shield-helper."+this,{detail:t});d.dispatchEvent(e)},v=!0,p=!1,b=void 0;try{for(var y,m=Object.keys(u)[Symbol.iterator]();!(v=(y=m.next()).done);v=!0){var h=y.value;u[h].subscribe(f,h)}}catch(t){p=!0,b=t}finally{try{!v&&m.return&&m.return()}finally{if(p)throw b}}n.exports=Object.defineProperties({add:function(t,e){return u[t]=e,n.exports},ready:{skillLevels:t("./get-levels")().then(function(t){var e=!0,n=!1,i=void 0;try{for(var o,r=function(){var e=o.value,n=c.observable(t[e]),i=a.integer("notify_at_lvl_"+e,0),r={};r["lvl_"+e]=n,r["notify_at_lvl_"+e]=i,r["lvl_should_notify_"+e]=c.pureComputed(function(){return i()>0&&n()>=i()}),r["lvl_should_notify_"+e+"_text"]=c.pureComputed(function(){return i()<1?"Disabled":i()<=n()?"Reached":i()-n()+" to go!"}),r["lvl_should_notify_"+e+"_class"]=c.pureComputed(function(){return i()<1?"active text-muted":i()<=n()?"success text-success":"info text-primary"});var s=!0,l=!1,d=void 0;try{for(var v,p=Object.keys(r)[Symbol.iterator]();!(s=(v=p.next()).done);s=!0){var b=v.value;r[b].subscribe(f,b)}}catch(t){l=!0,d=t}finally{try{!s&&p.return&&p.return()}finally{if(l)throw d}}Object.assign(u,r)},s=Object.keys(t)[Symbol.iterator]();!(e=(o=s.next()).done);e=!0)r()}catch(t){n=!0,i=t}finally{try{!e&&s.return&&s.return()}finally{if(n)throw i}}return t})}},{model:{get:function(){return u},configurable:!0,enumerable:!0}}),i("Debug "+e.script.name,function(){var t={},e={},n=!0,i=!1,r=void 0;try{for(var a,c=Object.keys(u)[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var d=a.value;t[d]=u[d]()}}catch(t){i=!0,r=t}finally{try{!n&&c.return&&c.return()}finally{if(i)throw r}}var f=!0,v=!1,p=void 0;try{for(var b,y=s()[Symbol.iterator]();!(f=(b=y.next()).done);f=!0){var m=b.value;e[m]=o(m)}}catch(t){v=!0,p=t}finally{try{!f&&y.return&&y.return()}finally{if(v)throw p}}console.debug({observables:t,storage:e}),l("See the console")})},{"./get-levels":2,"./gm-observable":3,"./toast":19}],5:[function(e,n,i){"use strict";var o=e("./sfx").notification;n.exports=function(e,n){console.debug("Notifying: "+e),n=$.extend({text:e,timeout:36e5,sound:!0,highlight:!0},n||{}),t(n),n.sound&&o.play()}},{"./sfx":13}],6:[function(t,e,n){"use strict";var i=d.querySelector(".attrib_value.ap_data"),o=t("../model").model.apPCT,r=t("../x-out-of-y");new MutationObserver(function(){var t=i.textContent.trim().match(r);t&&o(parseFloat(t[1])/parseFloat(t[2])*100)}).observe(i,t("./settings.json"))},{"../model":4,"../x-out-of-y":20,"./settings.json":10}],7:[function(t,e,n){"use strict";var i=d.querySelector(".timer_plaque"),o=t("../model").model.timer;new MutationObserver(function(){var t=i.textContent.trim();o(isNaN(t)?t:parseFloat(t))}).observe(i,t("./settings.json"))},{"../model":4,"./settings.json":10}],8:[function(t,e,n){"use strict";var i=$(".PopupCaptcha"),o=t("../model").model.captcha;new MutationObserver(function(){o(i.is(":visible"))}).observe(i[0],t("./settings.json"))},{"../model":4,"./settings.json":10}],9:[function(t,e,n){"use strict";var i=d.querySelector('.attrib_name[title="Hit Points"]').nextElementSibling,o=t("../model").model.hpPCT,r=t("../x-out-of-y");new MutationObserver(function(){var t=i.textContent.trim().match(r);t&&o(parseFloat(t[1])/parseFloat(t[2])*100)}).observe(i,t("./settings.json"))},{"../model":4,"../x-out-of-y":20,"./settings.json":10}],10:[function(t,e,n){e.exports={childList:!0,characterData:!0,attributes:!0,subtree:!0}},{}],11:[function(t,e,n){"use strict";var i=t("../model");i.ready.skillLevels.then(function(){var e=$("#mainContainer").find(".timer_line"),n=i.model,o=e.find(".Level")[0],r=e.find(".Skill")[0],s=t("./settings.json"),a=new MutationObserver(function(){if(o&&r){var t=o.textContent,e=r.textContent;t&&e&&n["lvl_"+e.trim().toLowerCase()](parseInt(t.trim()))}});a.observe(o.parentNode,s),console.debug("Skill level observer initialised")})},{"../model":4,"./settings.json":10}],12:[function(t,i,o){"use strict";var r=t("./model"),s=function(){var t=$(this).attr("data-key");r.model[t](!r.model[t]())},a=function(t,e){return $("<button/>").attr({type:"button",class:"btn","data-bind":"css: {'btn-danger': !"+t+"(), 'btn-success': "+t+"}","data-key":t}).click(s).append($("<span>"+e+": </span>"),$('<span data-bind="text: '+t+"() ? 'Enabled' : 'Disabled'\"/>"))},l=$('<div data-remodal-id="'+e.script.name+'"><button data-remodal-action="close" class="remodal-close"></button></div>'),u=d.createElement("div");l.append(u);var f=u.createShadowRoot(),v=$('<div class="container-fluid text-left"/>')[0];["bs_css1","bs_css2"].map(n).map(function(t){return"<style>"+t+"</style>"}).forEach(function(t){return f.appendChild($(t)[0])}),f.appendChild($("<style>.vertical-middle td{vertical-align:middle!important}</style>")[0]),f.appendChild(v);var p=$("<tbody/>");r.ready.skillLevels.then(function(t){var e=0,n=!0,i=!1,o=void 0;try{for(var s,a=Object.keys(t).sort()[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var l=s.value;p.append($('<tr data-bind="css:lvl_should_notify_'+l+'_class"/>').append('<td><label for="notify_at_lvl_'+e+'">'+l.ucFirst()+"</label></td>",$("<td/>").append($("<input/>").attr({type:"number",id:"notify_at_lvl_"+e,min:0,style:"width:85px",class:"form-control input-sm","data-bind":"value: notify_at_lvl_"+l})),$('<td><span data-bind="text: lvl_should_notify_'+l+'_text"/></td>'))),++e}}catch(t){i=!0,o=t}finally{try{!n&&a.return&&a.return()}finally{if(i)throw o}}c.applyBindings(r.model,p[0])}),$(v).append('<h1 class="text-center">'+e.script.name+" v"+e.script.version+"</h1>","<h3>Notification toggles</h3>",$('<div class="btn-group btn-group-xs">').append(a("notify_captcha","Captcha"),a("notify_AP","Full AP"),a("notify_HP","Full HP"),a("notify_timer","Idle")),"<hr/>",$('<h3 title="Notifies you when you reach a given skill level. Set to 0 to disable">Level notifications</h3>'),$('<table class="table table-condensed vertical-middle" style="width:auto"/>').append(p));var b=l.remodal({hashTracking:!1});$("#Left_menu").find(">.LeftMenu.LeftMenuLinks.side_block").prepend('<div class="smallchain"/>',$('<div class="toggle" style="text-align:center"><a href="javascript:void(0)">'+e.script.name+" options</a></div>").click(function(){b.open()})),c.applyBindings(r.model,v)},{"./model":4}],13:[function(t,e,n){"use strict";var i=new a.sound("https://cdn.rawgit.com/AlorelUserscripts/battered-shield-notifier/3cad641d61497ba25be33ae9db0ef30742628452/assets/notification.mp3",{preload:!0,autoplay:!1,loop:!1});e.exports={notification:i}},{}],14:[function(t,e,n){"use strict";var i=d.querySelector("#Left_menu a[href=\"javascript:PopupHandler.Popup('Cast');\"] div[data-selector]")||d.createElement("span"),o={onclick:function(){i.click()}},r=t("../notify"),s=t("../model").model;s.apPCT.subscribe(function(t){t>=100&&s.notify_AP()&&r("AP full!",o)})},{"../model":4,"../notify":5}],15:[function(t,e,n){"use strict";var i="Stopped",o=t("../notify"),r=t("../model").model;r.timer.subscribe(function(t){i==t&&r.notify_timer()&&o("Actions finished: "+t)})},{"../model":4,"../notify":5}],16:[function(t,e,n){"use strict";var i=t("../notify"),o={timeout:36e5},r=t("../model").model;r.captcha.subscribe(function(t){t&&r.notify_captcha()&&i("Captcha!",o)})},{"../model":4,"../notify":5}],17:[function(t,e,n){"use strict";var i=t("../notify"),o=t("../model").model;o.hpPCT.subscribe(function(t){t>=100&&o.notify_HP()&&i("HP full!")})},{"../model":4,"../notify":5}],18:[function(t,e,n){"use strict";var i=t("../notify"),o=t("../model");o.ready.skillLevels.then(function(t){var e=o.model,n=function(t){var n=this;t&&(i(n+" has reached the target level of "+e["notify_at_lvl_"+n]()+"!"),e["notify_at_lvl_"+n](0))},r=!0,s=!1,a=void 0;try{for(var l,c=Object.keys(t)[Symbol.iterator]();!(r=(l=c.next()).done);r=!0){var u=l.value;e["lvl_should_notify_"+u].subscribe(n,u),console.debug({skill:u,val:e["lvl_should_notify_"+u]()})}}catch(t){s=!0,a=t}finally{try{!r&&c.return&&c.return()}finally{if(s)throw a}}console.debug("Skill level subscriptions initialised")})},{"../model":4,"../notify":5}],19:[function(t,e,n){"use strict";var i={showHideTransition:"fade",allowToastClose:!0,hideAfter:5e3,stack:100,position:"top-right",bgColor:"#444444",textColor:"#eeeeee",textAlign:"left",loader:!1,loaderBg:"#9EC600"};e.exports=function(t,e){console.debug("Toasting: "+t),$.toast($.extend({text:t},i,e||{}))}},{}],20:[function(t,e,n){"use strict";e.exports=/([0-9\.]+)\s*\/\s*([0-9\.]+)/},{}]},{},[1])}(GM_notification,GM_info,GM_getResourceText,GM_registerMenuCommand,GM_getValue,GM_setValue,GM_listValues,buzz,Promise,ko,String,document);
